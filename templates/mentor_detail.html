{% extends "base.html" %}

{% block title %}{{ mentor.full_name or mentor.username }} - Book Session{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-10 px-4">
    <!-- Breadcrumb -->
    <nav class="flex mb-8" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{{ url_for('explore') }}" class="inline-flex items-center text-gray-700 hover:text-primary">
                    <i class="fas fa-search mr-2"></i> Find Mentors
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <span class="text-gray-500">{{ mentor.full_name or mentor.username }}</span>
                </div>
            </li>
        </ol>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column - Mentor Info -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-8">
                <!-- Mentor Header -->
                <div class="flex items-start justify-between mb-8">
                    <div class="flex items-center">
                        <div class="w-20 h-20 rounded-xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center mr-6">
                            <span class="text-3xl font-bold text-white">{{ (mentor.full_name or mentor.username)[0].upper() }}</span>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">{{ mentor.full_name or mentor.username }}</h1>
                            <p class="text-lg text-gray-600 mt-1">{{ mentor.job_title }} at {{ mentor.company }}</p>
                            <div class="flex items-center mt-3 space-x-4">
                                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                                    {{ mentor.domain }}
                                </span>
                                {% if mentor.is_verified %}
                                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium flex items-center">
                                    <i class="fas fa-check-circle mr-1"></i> Verified
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-bold text-primary">₹{{ mentor.price }}</div>
                        <div class="text-gray-500">per session</div>
                    </div>
                </div>

                <!-- Bio -->
                {% if mentor.bio %}
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">About</h3>
                    <p class="text-gray-700 leading-relaxed">{{ mentor.bio }}</p>
                </div>
                {% endif %}

                <!-- Skills -->
                {% if mentor.skills %}
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Skills & Expertise</h3>
                    <div class="flex flex-wrap gap-2">
                        {% for skill in mentor.skills.split(',') %}
                        <span class="px-3 py-2 bg-gray-100 text-gray-800 rounded-lg text-sm">
                            {{ skill.strip() }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Experience & Availability -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-2 flex items-center">
                            <i class="fas fa-briefcase mr-2 text-primary"></i> Experience
                        </h4>
                        <p class="text-gray-700">{{ mentor.experience or 'Not specified' }}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-2 flex items-center">
                            <i class="fas fa-clock mr-2 text-primary"></i> Availability
                        </h4>
                        <p class="text-gray-700">{{ mentor.availability or 'Flexible' }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Booking Form -->
        <div>
            <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-8 sticky top-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Book a Session</h2>
                
                <form method="POST" action="{{ url_for('mentor_detail', id=mentor.id) }}">
                    <!-- Service Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Select Service</label>
                        <div class="space-y-3">
                            {% for service in services %}
                            <div class="flex items-center">
                                <input type="radio" id="service{{ loop.index }}" name="service" value="{{ service }}" 
                                       required class="h-4 w-4 text-primary focus:ring-primary border-gray-300"
                                       {% if loop.first %}checked{% endif %}>
                                <label for="service{{ loop.index }}" class="ml-3 block text-sm font-medium text-gray-700">
                                    {{ service }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Date Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Select Date</label>
                        <div class="space-y-2 max-h-60 overflow-y-auto pr-2" id="dateSelector">
                            {% for slot in slots %}
                            <div class="date-option">
                                <input type="radio" id="date{{ loop.index }}" name="date" value="{{ slot.date }}" 
                                       required class="hidden peer" data-times="{{ slot.time }}">
                                <label for="date{{ loop.index }}" 
                                       class="block p-4 border border-gray-300 rounded-lg cursor-pointer peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:ring-2 peer-checked:ring-primary transition-all hover:border-gray-400">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-medium text-gray-900">{{ slot.display_date }}</div>
                                            <div class="text-sm text-gray-500">{{ slot.display_time }}</div>
                                        </div>
                                        <i class="fas fa-check-circle text-primary opacity-0 peer-checked:opacity-100 transition-opacity"></i>
                                    </div>
                                </label>
                            </div>
                            {% else %}
                            <div class="p-4 text-center border border-gray-300 rounded-lg">
                                <p class="text-gray-500">No available slots. Please check back later.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Time Selection -->
                    <div class="mb-6" id="timeSelector" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Select Time</label>
                        <div class="grid grid-cols-2 gap-3" id="timeOptions">
                            <!-- Times will be populated via JavaScript -->
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="mb-6">
                        <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">Additional Notes (Optional)</label>
                        <textarea id="notes" name="notes" rows="3" 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                  placeholder="Any specific topics you'd like to discuss..."></textarea>
                    </div>

                    <!-- Price Summary -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-600">Session Fee</span>
                            <span class="font-semibold text-gray-900">₹{{ mentor.price }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Platform Fee</span>
                            <span class="font-semibold text-gray-900">₹0</span>
                        </div>
                        <div class="border-t border-gray-300 mt-3 pt-3">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-gray-900">Total Amount</span>
                                <span class="text-2xl font-bold text-primary">₹{{ mentor.price }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="space-y-4">
                        {% if current_user.is_authenticated %}
                            <button type="submit" 
                                    class="w-full py-4 bg-gradient-to-r from-primary to-secondary text-white font-bold rounded-xl hover:shadow-lg transition-all hover:scale-105 flex items-center justify-center">
                                <i class="fas fa-calendar-check mr-3"></i> Book Session
                            </button>
                        {% else %}
                            <a href="{{ url_for('login') }}?next={{ request.path }}" 
                               class="block w-full py-4 bg-gradient-to-r from-primary to-secondary text-white font-bold rounded-xl hover:shadow-lg transition-all hover:scale-105 text-center">
                                <i class="fas fa-sign-in-alt mr-3"></i> Login to Book
                            </a>
                        {% endif %}
                        
                        <a href="{{ url_for('mentor_public_profile', profile_slug=mentor.profile_slug) }}" 
                           class="block w-full py-3 border-2 border-primary text-primary font-semibold rounded-xl hover:bg-primary hover:text-white transition-colors text-center">
                            <i class="fas fa-external-link-alt mr-3"></i> View Public Profile
                        </a>
                    </div>
                </form>

                <!-- Refund Policy -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="flex items-start text-sm text-gray-500">
                        <i class="fas fa-shield-alt mt-0.5 mr-3 text-primary"></i>
                        <div>
                            <p class="font-medium text-gray-700">100% Refund Policy</p>
                            <p class="mt-1">Full refund if session is cancelled 24 hours before scheduled time</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Handle date and time selection
document.addEventListener('DOMContentLoaded', function() {
    const dateOptions = document.querySelectorAll('.date-option input[type="radio"]');
    const timeSelector = document.getElementById('timeSelector');
    const timeOptions = document.getElementById('timeOptions');
    
    // Create a map of dates to times
    const dateTimeMap = {};
    {% for slot in slots %}
    dateTimeMap["{{ slot.date }}"] = "{{ slot.time }}";
    {% endfor %}
    
    dateOptions.forEach(option => {
        option.addEventListener('change', function() {
            const selectedDate = this.value;
            const timeValue = dateTimeMap[selectedDate];
            
            if (timeValue) {
                // Clear previous time options
                timeOptions.innerHTML = '';
                
                // Create time option
                const timeDiv = document.createElement('div');
                timeDiv.innerHTML = `
                    <input type="radio" id="time1" name="time" value="${timeValue}" 
                           required class="hidden peer" checked>
                    <label for="time1" 
                           class="block p-4 border border-gray-300 rounded-lg cursor-pointer peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:ring-2 peer-checked:ring-primary transition-all hover:border-gray-400 text-center">
                        <div class="font-medium text-gray-900">${formatTime(timeValue)}</div>
                        <div class="text-sm text-gray-500">Available</div>
                    </label>
                `;
                
                timeOptions.appendChild(timeDiv);
                timeSelector.style.display = 'block';
                
                // Scroll to time selector
                timeSelector.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
    });
    
    // Auto-select first date if available
    if (dateOptions.length > 0) {
        dateOptions[0].checked = true;
        dateOptions[0].dispatchEvent(new Event('change'));
    }
    
    // Format time from 24h to 12h
    function formatTime(time24) {
        const [hours, minutes] = time24.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const hour12 = hour % 12 || 12;
        return `${hour12}:${minutes} ${ampm}`;
    }
    
    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const selectedDate = document.querySelector('input[name="date"]:checked');
        const selectedTime = document.querySelector('input[name="time"]:checked');
        
        if (!selectedDate || !selectedTime) {
            e.preventDefault();
            alert('Please select both date and time for your session.');
            return false;
        }
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i> Booking...';
            submitBtn.disabled = true;
        }
    });
    
    // Initialize tooltips
    const tooltips = document.querySelectorAll('[data-tooltip]');
    tooltips.forEach(tooltip => {
        tooltip.addEventListener('mouseenter', function() {
            const tooltipText = this.getAttribute('data-tooltip');
            const tooltipEl = document.createElement('div');
            tooltipEl.className = 'absolute z-50 px-3 py-2 text-sm text-white bg-gray-900 rounded-lg shadow-lg';
            tooltipEl.textContent = tooltipText;
            tooltipEl.style.top = `${this.offsetTop - 40}px`;
            tooltipEl.style.left = `${this.offsetLeft}px`;
            tooltipEl.id = 'tooltip';
            document.body.appendChild(tooltipEl);
        });
        
        tooltip.addEventListener('mouseleave', function() {
            const tooltipEl = document.getElementById('tooltip');
            if (tooltipEl) {
                tooltipEl.remove();
            }
        });
    });
});
</script>
{% endblock %}
